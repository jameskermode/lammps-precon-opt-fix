# Test PreconLBFGS with exponential preconditioner
# Compressed Cu FCC structure

units metal
atom_style atomic

# Enable atom map (required for preconditioner)
atom_modify map yes

# Create compressed FCC Cu lattice
lattice fcc 3.615
region box block 0 3 0 3 0 3
create_box 1 box
create_atoms 1 box
mass 1 63.546

# Compress lattice by 0.5%
change_box all x scale 0.995 y scale 0.995 z scale 0.995 remap

# EAM potential for Cu
pair_style eam
pair_coeff * * /home/eng/essswb/lammps/lammps-22Jul2025/potentials/Cu_u3.eam

# Neighbor settings
# Use large skin to ensure neighbor cutoff > preconditioner r_cut
neighbor 3.0 bin
neigh_modify delay 0 every 1 check yes

# Load plugin
plugin load /home/eng/essswb/lammps-precon-opt-fix/build/preconlbfgsplugin.so

# Use PreconLBFGS with exponential preconditioner
# r_cut: -1.0 (auto-calculate as 2*r_NN)
# mu: -1.0 (auto-estimate, currently hardcoded to 10.0)
# A: 3.0 (exponential decay parameter)
# c_stab: 0.1 (diagonal stabilization)
fix opt all precon_lbfgs 0.01 precon exp r_cut -1.0 mu -1.0 A 3.0 c_stab 0.1 memory 50 maxstep 0.04

thermo 1
thermo_style custom step pe fmax fnorm

# Minimize
minimize 0.0 0.01 100 1000

# Cleanup
unfix opt
